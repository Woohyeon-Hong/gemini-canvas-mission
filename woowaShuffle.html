<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>우아한 야바위 (Elegant Shell Game)</title>
  <style>
    :root {
      --bg-color: #ffffff;
      --text-main: #121212;
      --text-sub: #5f6368;
      --accent-color: #1a73e8;
      --danger-color: #d93025;
      --cup-color: #333333;
      --ball-color: #fbbc04;
      --transition-speed: 0.5s;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', 'Noto Sans KR', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    #app {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }

    header {
      position: absolute;
      top: 4rem;
      text-align: center;
    }

    h1 {
      font-size: 1.2rem;
      font-weight: 300;
      letter-spacing: 0.5rem;
      text-transform: uppercase;
      color: var(--text-sub);
      margin-bottom: 0.5rem;
    }

    .section {
      display: none;
      width: 100%;
      max-width: 800px;
      text-align: center;
      animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .section.active { display: flex; flex-direction: column; align-items: center; }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .input-group { width: 100%; max-width: 320px; }

    input {
      width: 100%;
      padding: 1rem 0;
      font-size: 2rem;
      border: none;
      border-bottom: 1px solid #ddd;
      text-align: center;
      outline: none;
      background: transparent;
      transition: border-color 0.3s;
      font-weight: 200;
    }

    input:focus { border-bottom-color: var(--accent-color); }

    button {
      margin-top: 2rem;
      background: none;
      border: none;
      font-size: 1rem;
      font-weight: 500;
      color: var(--accent-color);
      cursor: pointer;
      letter-spacing: 0.1rem;
      transition: opacity 0.3s;
    }

    button:hover { opacity: 0.6; }
    button.danger { color: var(--danger-color); }

    /* 버튼 그룹 수평 정렬 */
    .button-group {
      display: flex;
      justify-content: center;
      gap: 3rem; /* 버튼 사이의 균형 잡힌 간격 */
      width: 100%;
    }

    #cups-container {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 4rem;
      height: 300px;
      margin-top: 2rem;
      width: 100%;
      position: relative;
    }

    .cup-wrapper {
      position: relative;
      width: 100px;
      height: 140px;
      transition: transform var(--transition-speed) cubic-bezier(0.45, 0, 0.55, 1);
    }

    .cup {
      width: 100px;
      height: 140px;
      background-color: var(--cup-color);
      border-radius: 4px;
      cursor: pointer;
      position: relative;
      z-index: 2;
      transition: transform 0.4s ease;
    }

    .cup.reveal { transform: translateY(-80px); }

    .ball {
      width: 24px;
      height: 24px;
      background-color: var(--ball-color);
      border-radius: 50%;
      position: absolute;
      bottom: 0;
      left: 38px;
      z-index: 1;
      display: none;
    }

    #board-instruction {
      font-size: 1.5rem;
      font-weight: 200;
      margin-bottom: 3rem;
    }

    .stats-display {
      font-size: 0.9rem;
      color: var(--text-sub);
      margin-top: 2rem;
      margin-bottom: 1rem;
      letter-spacing: 0.05rem;
    }

    .level-info {
      font-size: 0.75rem;
      color: var(--text-sub);
      margin-top: 1.5rem;
      line-height: 1.6;
      font-weight: 300;
    }

    #modal-overlay {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.98);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .modal-body { text-align: center; max-width: 400px; }
    .modal-body h3 { font-size: 1.5rem; font-weight: 300; margin-bottom: 1rem; }
  </style>
</head>
<body>

<div id="app">
  <header>
    <h1>우아한 야바위</h1>
  </header>

  <!-- 1. Intro Section (입장) -->
  <div id="section-intro" class="section active">
    <div class="input-group">
      <input type="text" id="nickname-input" placeholder="당신은 누구입니까?" maxlength="10">
    </div>
    <button id="btn-login">입장</button>
    <p id="msg-login-error" style="color: var(--danger-color); margin-top: 1rem; font-size: 0.8rem;"></p>
  </div>

  <!-- 2. Setting Section (라운드 설정) -->
  <div id="section-setting" class="section">
    <h2 id="welcome-text" style="font-size: 2.5rem; font-weight: 100; margin-bottom: 2rem;">환영합니다.</h2>
    <div class="input-group">
      <p style="color: var(--text-sub); margin-bottom: 1rem;">몇 개의 컵을 사용할까요?</p>
      <input type="number" id="cups-count-input" min="2" max="10" value="3">
    </div>
    <button id="btn-start-round">라운드 시작</button>

    <div class="level-info" id="current-speed-rule">
      속도 등급: 일반 (승률 20% 미만)
    </div>

    <div style="margin-top: 3rem;">
      <button id="btn-open-rename" style="font-size: 0.8rem; margin-right: 1.5rem;">닉네임 수정</button>
      <button id="btn-open-delete" class="danger" style="font-size: 0.8rem;">계정 삭제</button>
    </div>
  </div>

  <!-- 3. Game Section (플레이) -->
  <div id="section-game" class="section">
    <p id="board-instruction">잘 지켜보세요.</p>
    <div id="cups-container"></div>
  </div>

  <!-- 4. Result Section (결과) -->
  <div id="section-result" class="section">
    <h2 id="result-title" style="font-size: 3rem; font-weight: 100; margin-bottom: 1rem;">찾았습니다.</h2>
    <div class="stats-display">
      <p id="stat-win-rate">승률: 0.00%</p>
      <p id="stat-score-detail">0승 / 0패</p>
      <p id="stat-speed-rank" style="margin-top: 0.5rem; font-weight: 500;"></p>
    </div>
    <!-- 버튼 정렬 수정을 위해 .button-group 추가 -->
    <div class="button-group">
      <button id="btn-next-round">다음 라운드</button>
      <button id="btn-exit">홈으로 이동</button>
    </div>
  </div>
</div>

<!-- 미니멀 모달 오버레이 -->
<div id="modal-overlay">
  <div class="modal-body">
    <h3 id="modal-title">알림</h3>
    <p id="modal-desc" style="color: var(--text-sub); margin-bottom: 2rem;"></p>
    <div id="modal-input-field" style="display: none; margin-bottom: 2rem;">
      <input type="text" id="modal-text-input" style="font-size: 1.5rem;" placeholder="새 이름 입력">
    </div>
    <div style="display: flex; justify-content: center; gap: 3rem;">
      <button id="modal-btn-confirm">네</button>
      <button id="modal-btn-cancel" style="color: var(--text-sub);">아니요</button>
    </div>
  </div>
</div>

<script>
  const qs = (s) => document.querySelector(s);
  const qsa = (s) => document.querySelectorAll(s);

  const Storage = {
    KEY: 'shell_game_v2',
    load: () => JSON.parse(localStorage.getItem(Storage.KEY) || '{}'),
    save: (data) => localStorage.setItem(Storage.KEY, JSON.stringify(data))
  };

  const state = {
    players: Storage.load(),
    currentNick: '',
    numCups: 3,
    ballPos: 0,
    shuffling: false
  };

  const UI = {
    go(id) {
      qsa('.section').forEach(s => s.classList.remove('active'));
      qs(`#section-${id}`).classList.add('active');
    },
    modal({ title, desc, input = false, onConfirm }) {
      qs('#modal-title').textContent = title;
      qs('#modal-desc').textContent = desc;
      qs('#modal-input-field').style.display = input ? 'block' : 'none';
      qs('#modal-overlay').style.display = 'flex';
      qs('#modal-btn-confirm').onclick = () => onConfirm(qs('#modal-text-input').value.trim());
      qs('#modal-btn-cancel').onclick = () => qs('#modal-overlay').style.display = 'none';
    },
    updateSpeedGuide(winRate) {
      const guide = qs('#current-speed-rule');
      const info = getSpeedInfo(winRate);
      guide.innerHTML = `
                    <div style="color:var(--accent-color); font-weight: 500; margin-bottom: 4px;">속도 등급: ${info.rank}</div>
                    <div>규칙: 승률이 높을수록 컵이 더 빠르게 섞입니다.</div>
                    <div style="margin-top: 4px; opacity: 0.7;">
                        0-20%: 일반 | 20-50%: 빠름 | 50-80%: 어려움 | 80%+: 전문가
                    </div>
                `;
    }
  };

  function getSpeedInfo(winRate) {
    if (winRate < 20) return { ms: 450, rank: "일반" };
    if (winRate < 50) return { ms: 300, rank: "빠름" };
    if (winRate < 80) return { ms: 200, rank: "어려움" };
    return { ms: 120, rank: "전문가" };
  }

  function init() {
    qs('#btn-login').onclick = login;
    qs('#btn-start-round').onclick = setupGame;
    qs('#btn-next-round').onclick = () => {
      const p = state.players[state.currentNick];
      const winRate = p.total > 0 ? (p.wins / p.total) * 100 : 0;
      UI.updateSpeedGuide(winRate);
      UI.go('setting');
    };
    qs('#btn-exit').onclick = () => UI.go('intro');
    qs('#btn-open-rename').onclick = rename;
    qs('#btn-open-delete').onclick = removeAccount;
  }

  function login() {
    const nick = qs('#nickname-input').value.trim();
    if (!nick) return (qs('#msg-login-error').textContent = "이름을 입력해주세요.");

    if (state.players[nick]) {
      state.currentNick = nick;
      enterHome();
    } else {
      UI.modal({
        title: "새 플레이어",
        desc: `"${nick}"님은 처음이시군요! 새로 등록할까요?`,
        onConfirm: () => {
          state.players[nick] = { wins: 0, total: 0 };
          Storage.save(state.players);
          state.currentNick = nick;
          qs('#modal-overlay').style.display = 'none';
          enterHome();
        }
      });
    }
  }

  function enterHome() {
    qs('#welcome-text').textContent = `환영합니다, ${state.currentNick}님.`;
    const p = state.players[state.currentNick];
    const winRate = p.total > 0 ? (p.wins / p.total) * 100 : 0;
    UI.updateSpeedGuide(winRate);
    UI.go('setting');
  }

  function rename() {
    UI.modal({
      title: "이름 수정",
      desc: "변경하실 새로운 이름을 알려주세요.",
      input: true,
      onConfirm: (newNick) => {
        if (!newNick || state.players[newNick]) return alert("사용할 수 없거나 이미 존재하는 이름입니다.");
        const data = state.players[state.currentNick];
        delete state.players[state.currentNick];
        state.players[newNick] = data;
        state.currentNick = newNick;
        Storage.save(state.players);
        qs('#modal-overlay').style.display = 'none';
        enterHome();
      }
    });
  }

  function removeAccount() {
    UI.modal({
      title: "계정 삭제",
      desc: "지금까지의 모든 기록이 영구적으로 삭제됩니다. 계속할까요?",
      onConfirm: () => {
        delete state.players[state.currentNick];
        Storage.save(state.players);
        state.currentNick = '';
        qs('#modal-overlay').style.display = 'none';
        UI.go('intro');
      }
    });
  }

  function setupGame() {
    state.numCups = parseInt(qs('#cups-count-input').value) || 3;
    if (state.numCups < 2 || state.numCups > 10) return alert("컵은 2개에서 10개 사이로 선택해주세요.");

    UI.go('game');
    qs('#board-instruction').textContent = "공의 위치를 잘 기억하세요.";
    renderCups();

    state.ballPos = Math.floor(Math.random() * state.numCups);
    const wrappers = qsa('.cup-wrapper');

    setTimeout(() => {
      wrappers[state.ballPos].querySelector('.cup').classList.add('reveal');
      wrappers[state.ballPos].querySelector('.ball').style.display = 'block';

      setTimeout(() => {
        wrappers[state.ballPos].querySelector('.cup').classList.remove('reveal');
        setTimeout(() => {
          wrappers[state.ballPos].querySelector('.ball').style.display = 'none';
          shuffle();
        }, 400);
      }, 1200);
    }, 600);
  }

  function renderCups() {
    const container = qs('#cups-container');
    container.innerHTML = '';
    for (let i = 0; i < state.numCups; i++) {
      const w = document.createElement('div');
      w.className = 'cup-wrapper';
      w.innerHTML = `<div class="cup" onclick="select(${i})"></div><div class="ball"></div>`;
      container.appendChild(w);
    }
  }

  async function shuffle() {
    state.shuffling = true;
    qs('#board-instruction').textContent = "공을 섞는 중...";
    const wrappers = Array.from(qsa('.cup-wrapper'));
    const map = wrappers.map((_, i) => i);

    const p = state.players[state.currentNick];
    const winRate = p.total > 0 ? (p.wins / p.total) * 100 : 0;
    const speed = getSpeedInfo(winRate);

    document.documentElement.style.setProperty('--transition-speed', `${speed.ms}ms`);

    for (let i = 0; i < 10; i++) {
      await new Promise(r => {
        let a = Math.floor(Math.random() * state.numCups);
        let b = Math.floor(Math.random() * state.numCups);
        while(a === b) b = Math.floor(Math.random() * state.numCups);
        [map[a], map[b]] = [map[b], map[a]];
        wrappers.forEach((el, idx) => {
          const target = map.indexOf(idx);
          el.style.transform = `translateX(${(target - idx) * 140}px)`;
        });
        setTimeout(r, speed.ms);
      });
    }
    state.shuffling = false;
    qs('#board-instruction').textContent = "공은 어디에 있을까요?";
  }

  function select(idx) {
    if (state.shuffling) return;
    const win = (idx === state.ballPos);

    qsa('.cup')[state.ballPos].classList.add('reveal');
    qsa('.ball')[state.ballPos].style.display = 'block';
    if (!win) qsa('.cup')[idx].style.background = '#ddd';

    setTimeout(() => finish(win), 1200);
  }

  function finish(win) {
    const p = state.players[state.currentNick];
    p.total++;
    if (win) p.wins++;
    Storage.save(state.players);

    const winRate = (p.wins/p.total)*100;
    const info = getSpeedInfo(winRate);

    UI.go('result');
    qs('#result-title').textContent = win ? "찾았습니다." : "놓쳤습니다.";
    qs('#stat-win-rate').textContent = `승률: ${winRate.toFixed(2)}%`;
    qs('#stat-score-detail').textContent = `${p.wins}승 / ${p.total - p.wins}패`;
    qs('#stat-speed-rank').textContent = `현재 등급: ${info.rank}`;
    qs('#stat-speed-rank').style.color = info.rank === '전문가' ? 'var(--danger-color)' : 'var(--accent-color)';
  }

  window.onload = init;
</script>
</body>
</html>